name: Update POT file

on:
  push:
    branches:
      - main
    paths:
      - '**.php'
  workflow_dispatch:

jobs:
  update-pot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP with tools
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.3'
          tools: composer, wp-cli

      - name: Install dependencies
        run: |
          wp package install wp-cli/i18n-command:2.2.8

      - name: Update POT file
        run: wp i18n make-pot . languages/woocommerce-pos.pot --domain=woocommerce-pos --slug=woocommerce-pos --package-name="WCPOS" --headers="{\"Report-Msgid-Bugs-To\":\"https://github.com/wcpos/woocommerce-pos/issues\"}"

      - name: Check for changes
        id: git-diff
        run: |
          git show HEAD:languages/woocommerce-pos.pot > old.pot 2>/dev/null || {
            echo "changes=true" >> $GITHUB_OUTPUT
            rm -f old.pot
            exit 0
          }

          tail -n +16 languages/woocommerce-pos.pot > new-trimmed.pot
          tail -n +16 old.pot > old-trimmed.pot

          if diff old-trimmed.pot new-trimmed.pot; then
            echo "No changes detected."
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

          rm -f old.pot new-trimmed.pot old-trimmed.pot

      - name: Create PR with updated POT file
        if: steps.git-diff.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B chore/update-pot-file
          git add '*.pot'
          git commit -m 'chore(i18n): update languages/woocommerce-pos.pot'
          git push -f origin chore/update-pot-file
          # Create or update PR
          gh pr create \
            --title 'chore(i18n): update languages/woocommerce-pos.pot' \
            --body 'Automated POT file update.' \
            --base main \
            --head chore/update-pot-file || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

