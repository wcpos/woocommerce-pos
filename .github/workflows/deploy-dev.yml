name: Deploy to Dev Site

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ— Checkout code
        uses: actions/checkout@v4

      - name: ðŸ— Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.8.0'

      - name: ðŸ‘· Build
        run: |
          pnpm install
          composer prefix-dependencies
          composer install --no-dev
          pnpm settings build
          pnpm analytics build

      - name: ðŸ“¦ Create deployment package
        run: |
          # Create staging directory
          mkdir -p deploy-staging
          
          # Copy files excluding build artifacts and source files
          # NOTE: vendor/ is REQUIRED - it contains PHP classes loaded via composer
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='packages/*/node_modules' \
            --exclude='tests' \
            --exclude='.gitignore' \
            --exclude='.editorconfig' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='package.json' \
            --exclude='pnpm-lock.yaml' \
            --exclude='pnpm-workspace.yaml' \
            --exclude='turbo.json' \
            --exclude='tsconfig.json' \
            --exclude='.eslintrc*' \
            --exclude='.prettierrc*' \
            --exclude='*.md' \
            --exclude='packages/*/src' \
            --exclude='packages/*/tsconfig.json' \
            --exclude='packages/*/package.json' \
            ./ deploy-staging/
          
          # Create tarball from staging directory
          cd deploy-staging
          tar -czf ../woocommerce-pos.tar.gz .
          cd ..

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 213.239.218.130 >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to dev-free.wcpos.com
        run: |
          # Upload tarball
          scp -o StrictHostKeyChecking=no woocommerce-pos.tar.gz root@213.239.218.130:/tmp/
          
          # Extract and deploy
          ssh -o StrictHostKeyChecking=no root@213.239.218.130 << 'EOF'
            set -e
            PLUGIN_DIR="/data/wordpress/dev-free/html/wp-content/plugins/woocommerce-pos"
            
            # Create directory
            mkdir -p "$PLUGIN_DIR"
            
            # Backup current version (optional)
            if [ -d "$PLUGIN_DIR" ] && [ "$(ls -A $PLUGIN_DIR)" ]; then
              mv "$PLUGIN_DIR" "${PLUGIN_DIR}.backup.$(date +%s)"
            fi
            
            # Extract new version
            mkdir -p "$PLUGIN_DIR"
            cd "$PLUGIN_DIR"
            tar -xzf /tmp/woocommerce-pos.tar.gz
            
            # Fix permissions
            chown -R 82:82 "$PLUGIN_DIR"
            
            # Cleanup
            rm -f /tmp/woocommerce-pos.tar.gz
            rm -rf "${PLUGIN_DIR}.backup."* 2>/dev/null || true
            
            echo "âœ… Deployed to dev-free.wcpos.com"
          EOF

      - name: ðŸš€ Deploy to dev-pro.wcpos.com
        run: |
          # Upload tarball
          scp -o StrictHostKeyChecking=no woocommerce-pos.tar.gz root@213.239.218.130:/tmp/
          
          # Extract and deploy
          ssh -o StrictHostKeyChecking=no root@213.239.218.130 << 'EOF'
            set -e
            PLUGIN_DIR="/data/wordpress/dev-pro/html/wp-content/plugins/woocommerce-pos"
            
            # Create directory
            mkdir -p "$PLUGIN_DIR"
            
            # Backup current version (optional)
            if [ -d "$PLUGIN_DIR" ] && [ "$(ls -A $PLUGIN_DIR)" ]; then
              mv "$PLUGIN_DIR" "${PLUGIN_DIR}.backup.$(date +%s)"
            fi
            
            # Extract new version
            mkdir -p "$PLUGIN_DIR"
            cd "$PLUGIN_DIR"
            tar -xzf /tmp/woocommerce-pos.tar.gz
            
            # Fix permissions
            chown -R 82:82 "$PLUGIN_DIR"
            
            # Cleanup
            rm -f /tmp/woocommerce-pos.tar.gz
            rm -rf "${PLUGIN_DIR}.backup."* 2>/dev/null || true
            
            echo "âœ… Deployed to dev-pro.wcpos.com"
          EOF
